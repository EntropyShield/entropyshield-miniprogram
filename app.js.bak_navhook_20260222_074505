// app.js - 启动应用并确保环境变量与数据库配置

const { API_BASE, ENV, runtime } = require('./config');  // 从 config.js 获取 API_BASE 和环境配置

App({
  onLaunch(options) {
    // [ADD] 统一接收分享/扫码携带的邀请码，落地 pendingInviteCode（供裂变页自动绑定）
    try {
      const q = (options && options.query) ? options.query : {};
      if (q && q.inviteCode) {
        wx.setStorageSync('pendingInviteCode', String(q.inviteCode).trim().toUpperCase());
      }

      // 预留：后续小程序码(getwxacodeunlimit)走 scene，同样落 pendingInviteCode
      // 兼容：有些入口会把 scene 放在 query.scene；也兼容 options.scene 为字符串时
      if (q && q.scene) {
        wx.setStorageSync('pendingInviteCode', decodeURIComponent(String(q.scene)).trim().toUpperCase());
      } else if (options && typeof options.scene === 'string' && options.scene) {
        wx.setStorageSync('pendingInviteCode', decodeURIComponent(String(options.scene)).trim().toUpperCase());
      }
    } catch (e) {}

    // 1) 启动时强制写入最新 API_BASE，彻底干掉旧缓存/旧兜底
    try {
      // 这里确保写入最新的生产环境地址
      wx.setStorageSync('apiBaseUrl', API_BASE); // 确保 API_BASE 是 https://api.entropyshield.com
      wx.setStorageSync('API_BASE', API_BASE);    // 确保 API_BASE 是 https://api.entropyshield.com

      console.log('[BOOT] ENV=', ENV, 'platform=', runtime && runtime.platform, 'envVersion=', runtime && runtime.envVersion);
      console.log('[BOOT] API_BASE=', API_BASE); // 打印出 API_BASE，确保使用的是正确的后端地址
    } catch (e) {
      console.log('[BOOT] setStorage failed:', e);  // 错误处理
    }

    // 2) 健康检查：确认真机/预览/体验版是否成功访问线上域名
    try {
      // 确保健康检查请求的 URL 正确指向生产环境地址
      wx.request({
        url: API_BASE + '/api/health',  // 使用从 config.js 获取的 API_BASE 地址，确保正确指向后端接口
        method: 'GET',
        timeout: 10000,  // 设置请求超时为 10 秒
        success: (res) => {
          console.log('[BOOT] /api/health ok:', res.data); // 如果请求成功，打印响应数据
        },
        fail: (err) => {
          console.log('[BOOT] /api/health fail:', err);  // 如果请求失败，打印错误信息
          wx.showToast({
            title: '网络异常，请稍后重试',
            icon: 'none'
          });
        }
      });
    } catch (e) {
      console.log('[BOOT] health request exception:', e);  // 捕获请求异常
      wx.showToast({
        title: '健康检查失败，请稍后再试',
        icon: 'none'
      });
    }

    // 3) 你已有的逻辑（如果后续要加回去，放这里）
    // ... 你已有的逻辑 ...
  },

  globalData: {
    // 统一使用 config.js 解析后的 API_BASE（DevTools=本地3000；真机=线上https）
    baseUrl: API_BASE  // 这里会自动使用正确的生产地址
  }
});

// --- 防止代码依赖分析忽略管理端页面（开发环境用）---
// 如果不需要管理端页面的逻辑，下面的代码可以删除
if (false) {
  require('./pages/visitAdmin/index.js');
}