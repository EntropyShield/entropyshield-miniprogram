// pages/campReport/index.js 


// [ADD-FINISH-REPORT] CAMP_FINISH_ONSHOW
function __campReportTryFinishOnce() {
  try {
    if (wx.__campFinishOnReportSent) return;
    // 判定是否完成 7/7（优先 campFinishedMap，其次 campDailyLogs）
    var doneMap = wx.getStorageSync('campFinishedMap') || {};
    var done7 = !!(doneMap.D7 || doneMap['D7'] || (Object.keys(doneMap || {}).length >= 7));
    if (!done7) {
      var logs = wx.getStorageSync('campDailyLogs') || {};
      var keys = Object.keys(logs || {}).filter(function(k){ return /^D[1-7]$/.test(k); });
      done7 = keys.length >= 7;
    }
    if (!done7) return;

    var base = wx.getStorageSync('API_BASE') || wx.getStorageSync('apiBaseUrl') || '';
    var clientId = wx.getStorageSync('clientId') || '';
    if (!base || !clientId) return;

    wx.__campFinishOnReportSent = true;
    wx.request({
      url: base + '/api/fission/camp/finish',
      method: 'POST',
      header: { 'content-type': 'application/json' },
      data: { clientId: clientId },
      success: function(res){ console.log('[ADD-FINISH-REPORT] camp/finish resp:', res.data); },
      fail: function(err){ console.error('[ADD-FINISH-REPORT] camp/finish fail:', err); }
    });
  } catch (e) {
    console.error('[ADD-FINISH-REPORT] error:', e);
  }
}

Page({
    // [ADD-FINISH-REPORT] trigger finish
  onShow: function() {
    __campReportTryFinishOnce();
  },
data: {
    // 顶部总览
    summary: {
      score: 0,
      levelName: '',
      levelTag: '',
      finishedDays: 0,
      goodDays: 0,
      badDays: 0,
      brief: '',
      tags: []
    },

    // 7 日执行明细
    dayStats: [],

    // AI 建议
    advice: {
      suggestions: []
    },

    // 多轮训练营信息（后续可用于在 WXML 展示“第几轮”“本轮奖励几次”）
    campRoundCount: 0,   // 已完成并发过奖励的轮数
    rewardThisRound: 0   // 本轮新增的奖励次数（0、2 或 4）
  },

  onLoad() {
    this.buildReport();
  },

  onShow() {
    this.buildReport();
  },

  /**
   * 汇总 campDailyLogs，生成 7 日执行报告
   */
  buildReport() {
    const logs = wx.getStorageSync('campDailyLogs') || {};

    const dayMeta = [
      { day: 'D1', name: '止亏觉醒' },
      { day: 'D2', name: '账户体检' },
      { day: 'D3', name: '仓位框架' },
      { day: 'D4', name: '止损规则' },
      { day: 'D5', name: '盈利结构' },
      { day: 'D6', name: '情绪减震' },
      { day: 'D7', name: '系统固化' }
    ];

    let totalScore = 0;
    let effectiveDays = 0; // 有记录/完成的天数
    let goodDays = 0;      // 得分 >= 70
    let badDays = 0;       // 得分 > 0 且 < 40

    const dayStats = dayMeta.map(meta => {
      const log = logs[meta.day] || {};
      const score =
        typeof log.score === 'number' ? log.score : 0;

      const hasContent = !!(
        log.dailyNote ||
        log.practiceNote ||
        log.reviewNote ||
        log.homeworkNote
      );

      // 优先使用 finished 标记；没有 finished 时，退回到 hasContent
      const isFinished = (log.finished === true) || hasContent;

      if (isFinished) {
        effectiveDays += 1;
        totalScore += score;

        if (score >= 70) goodDays += 1;
        if (score > 0 && score < 40) badDays += 1;
      }

      let scoreText = '暂无有效记录';
      if (isFinished) {
        scoreText =
          score > 0 ? `得分 ${score} 分` : '已记录，未评分';
      } else if (hasContent) {
        // 有内容但未标记 finished 的情况
        scoreText = '有记录，建议补充完成评分';
      }

      const desc =
        log.brief ||
        (isFinished
          ? '已完成当日打卡，建议晚间再复盘一次。'
          : '还没有当天的风控记录，可以从一条简单的记事开始。');

      return {
        day: meta.day,
        name: meta.name,
        score,
        hasContent: isFinished,
        scoreText,
        desc
      };
    });

    // 计算平均分
    const avgScore =
      effectiveDays > 0
        ? Math.round(totalScore / effectiveDays)
        : 0;

    // 等级&标签&总体描述
    let levelName = 'Lv.0 尚未成型';
    let levelTag = '记录起步';
    let brief =
      '建议先坚持连续记录 7 天，再来看账户和心态的变化。';

    if (avgScore >= 80 && effectiveDays >= 5) {
      levelName = 'Lv.3 稳健执行者';
      levelTag = '执行较稳定';
      brief =
        '你已经具备比较稳定的风控执行节奏，可以开始把自己的规则固化下来。';
    } else if (avgScore >= 60 && effectiveDays >= 4) {
      levelName = 'Lv.2 记录养成者';
      levelTag = '记录有起步';
      brief =
        '你已经可以在部分交易日留下记录，只要把记录做满一周，画像会更加清晰。';
    } else if (effectiveDays >= 3) {
      levelName = 'Lv.1 觉察启动者';
      levelTag = '开始关注风控';
      brief =
        '你已经开始注意自己的回撤与仓位，接下来重点是「每天都留下一条记录」。';
    }

    // 补充标签
    const tags = [levelTag];
    if (effectiveDays >= 5) tags.push('记录较稳定');
    if (goodDays >= 3) tags.push('优秀执行日较多');
    if (badDays > 0) tags.push('仍有情绪化交易日');

    const summary = {
      score: avgScore,
      levelName,
      levelTag,
      finishedDays: effectiveDays,
      goodDays,
      badDays,
      brief,
      tags
    };

    // AI 建议文案（简单按情况组合）
    const suggestions = [];
    if (effectiveDays < 4) {
      suggestions.push(
        '先把「记录习惯」打牢，目标是一周内至少完成 5 天有效打卡。'
      );
    } else {
      suggestions.push(
        '记录已经基本养成习惯，可以开始把固定的风控清单写在手机或本子里，交易前后对照执行。'
      );
    }

    if (avgScore < 60) {
      suggestions.push(
        '目前风控执行还有明显漏网之鱼，建议先把「单笔最大亏损」「单日最大回撤」这两条铁律写清楚并严格遵守。'
      );
    } else {
      suggestions.push(
        '你的止损与仓位控制已经有一定执行力，可以在保证回撤可控的前提下，适当提高盈利目标。'
      );
    }

    if (badDays > 0) {
      suggestions.push(
        '可以给自己设定「情绪减震器」：例如每天限制看盘次数、下单前强制等待 3 分钟等，降低情绪交易冲动。'
      );
    }

    const advice = { suggestions };

    // 先把报告本身的数据写入
    this.setData({
      summary,
      dayStats,
      advice
    });

    // ===== 新增：多轮训练营奖励逻辑 =====
    // 用有效完成天数作为 doneDays（你这套逻辑里即 7/7）
    const doneDays = effectiveDays;
    this.handleCampMultiRoundReward(doneDays, logs);
  },

  /**
   * 多轮训练营奖励逻辑：
   * - 第 1 轮 7/7：+4 次
   * - 第 2 / 3 轮 7/7：各 +2 次
   * - 第 4 轮及以后：不再发次数，只记录轮次
   *
   * 参数：
   *  - doneDays: 已完成天数（整数）
   *  - campDailyLogs: 打卡日志对象（用于生成“签名”，防止同一轮重复发奖）
   */
  handleCampMultiRoundReward(doneDays, campDailyLogs) {
    // 不是 7/7，直接只更新轮数展示，不发奖励
    if (doneDays !== 7) {
      const campStatus = wx.getStorageSync('campStatus') || {};
      const roundCount = Number(campStatus.campRoundCount || 0);

      this.setData({
        campRoundCount: roundCount,
        rewardThisRound: 0
      });
      return;
    }

    // 1）读取历史状态
    const CAMP_STATUS_KEY = 'campStatus';
    let campStatus = wx.getStorageSync(CAMP_STATUS_KEY) || {};
    let roundCount = Number(campStatus.campRoundCount || 0);
    const lastSign = campStatus.lastRewardedSign || '';

    // 2）用 campDailyLogs 生成一个“签名”，避免同一批日志重复领奖
    let currentSign = '';
    try {
      currentSign = JSON.stringify(campDailyLogs || {});
    } catch (e) {
      currentSign = String(Date.now()); // 极端情况下兜底
    }

    // 如果签名相同，说明这轮已经发过奖了，什么都不做
    if (currentSign === lastSign) {
      this.setData({
        campRoundCount: roundCount,
        rewardThisRound: 0
      });
      return;
    }

    // 3）新的一轮 7/7 完成
    const thisRound = roundCount + 1;

    // 按轮数决定奖励次数
    let rewardTimes = 0;
    if (thisRound === 1) {
      rewardTimes = 4;
    } else if (thisRound === 2 || thisRound === 3) {
      rewardTimes = 2;
    } else {
      rewardTimes = 0;
    }

    // 4）给用户发放完整方案次数
    if (rewardTimes > 0) {
      const RIGHTS_KEY = 'userRights';
      const rights = wx.getStorageSync(RIGHTS_KEY) || {};
      const oldTimes = Number(rights.freeCalcTimes || 0) || 0;
      const newTimes = oldTimes + rewardTimes;

      rights.freeCalcTimes = newTimes;

      // 如果目前没有会员名称，则默认标记为“7天风控训练营奖励”
      if (!rights.membershipName) {
        rights.membershipName = '7天风控训练营奖励';
      }

      wx.setStorageSync(RIGHTS_KEY, rights);

      wx.showToast({
        title: `第 ${thisRound} 轮训练营完成，本轮奖励 ${rewardTimes} 次完整方案`,
        icon: 'none',
        duration: 2600
      });
    } else {
      // 第 4 轮及以后，不发次数，只给一个荣誉提示（可选）
      wx.showToast({
        title: `你已完成第 ${thisRound} 轮 7 天训练，这已经远超大多数交易者！`,
        icon: 'none',
        duration: 2600
      });
    }

    // 5）更新 campStatus，记录当前轮次 & 本轮签名
    campStatus.campRoundCount = thisRound;
    campStatus.lastRewardedSign = currentSign;
    campStatus.lastRewardedAt = Date.now();

    wx.setStorageSync(CAMP_STATUS_KEY, campStatus);

    // 6）更新页面数据（后续要展示可以直接用）
    this.setData({
      campRoundCount: thisRound,
      rewardThisRound: rewardTimes
    });
  },

  // 返回训练营日历
  goCampIntro() {
    wx.navigateBack();
  },

  // 去风控计算器
  goCalc() {
    wx.navigateTo({
      url: '/pages/riskCalculator/index'
    });
  },

  // 去进阶控局者服务（会员收费页）
  goMembership() {
    wx.navigateTo({
      url: '/pages/membership/index?from=campReport'
    });
  }
});
