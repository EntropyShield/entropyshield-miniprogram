<view class="page">
  <view class="header">
    <view class="header-title">我的课程进度</view>
    <view class="header-sub">你已经加入的控局课程会出现在这里，可随时更新学习进度。</view>
  </view>

  <view class="filter-bar">
    <view class="tab {{filterType === 'all' ? 'active' : ''}}" data-type="all" bindtap="onChangeFilter">全部</view>
    <view class="tab {{filterType === 'in_progress' ? 'active' : ''}}" data-type="in_progress" bindtap="onChangeFilter">进行中</view>
    <view class="tab {{filterType === 'finished' ? 'active' : ''}}" data-type="finished" bindtap="onChangeFilter">已完成</view>
  </view>

  <view wx:if="{{loading}}" class="tip-text">加载中…</view>
  <view wx:if="{{!loading && errorMsg}}" class="tip-text tip-error">{{errorMsg}}</view>

  <view wx:if="{{!loading && !errorMsg && (!items || items.length === 0)}}" class="tip-text">
    你还没有加入任何课程，可以先从「控局者」页进入控局日历报名。
  </view>

  <scroll-view
    wx:if="{{!loading && !errorMsg && items && items.length > 0}}"
    scroll-y="true"
    class="list"
    scroll-into-view="{{scrollIntoView}}"
  >
    <block wx:for="{{items}}" wx:key="id">
      <view
        class="card {{focusCourseId && (''+item.courseId)==(''+focusCourseId) ? 'card-focus' : ''}}"
        id="course-{{item.courseId}}"
        bindtap="onTapItem"
        data-id="{{item.id}}"
      >
        <view class="card-main">
          <view class="card-title">{{item.title}}</view>
          <view class="card-time">{{item.timeText}}</view>

          <view class="card-meta">
            <view class="status-tag {{item.status === 'finished' ? 'status-finished' : 'status-progress'}}">
              {{item.statusText}}
            </view>
            <view class="progress-text">进度：{{item.progressPercent || 0}}%</view>
          </view>

          <view class="progress-bar">
            <view class="progress-inner" style="width: {{item.progressWidth}};"></view>
          </view>

          <view wx:if="{{item.lastLesson}}" class="card-last">最近学习：{{item.lastLesson}}</view>
          <view wx:if="{{item.updatedAtText}}" class="card-updated">更新于 {{item.updatedAtText}}</view>
        </view>

        <view class="card-actions" catchtap="noop">
          <button class="btn-secondary" size="mini" data-id="{{item.id}}" bindtap="onUpdateProgress">更新进度</button>
          <button class="btn-primary" size="mini" data-id="{{item.id}}" bindtap="onMarkFinished">标记完成</button>
        </view>
      </view>
    </block>
  </scroll-view>
</view>
